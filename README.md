# Kokzhiek Editor Backend

A complete authentication system with role-based access control and registration key management.

## Quick Start

### 1. Installation
```bash
npm install
```

### 2. Environment Setup
Copy `.env.example` to `.env` and configure your environment variables:

```bash
cp .env.example .env
```

**Required Environment Variables:**
- `DATABASE_URL` or `NEON_DATABASE_URL` - Your PostgreSQL connection string
- `JWT_SECRET` - Secret key for JWT token generation
- `SMTP_HOST`, `SMTP_PORT`, `SMTP_USER`, `SMTP_PASS` - Email configuration

### 3. Database Setup

#### Generate Migrations (Already Done)
```bash
npm run db:generate
```

#### Push Migrations to Database
```bash
npm run db:migrate
```

#### Create Super Admin (First Time Setup)
```bash
npm run create-super-admin
```

### 4. Run Tests
```bash
npm test
```

### 5. Start Development Server
```bash
npm run dev
```

## ðŸ“š API Documentation

### Swagger UI
- **Interactive API Docs**: `http://localhost:3000/api-docs`
- **OpenAPI JSON Spec**: `http://localhost:3000/api-docs.json`
- **Frontend Swagger UI**: Open `frontend-swagger.html` in your browser

The Swagger UI provides:
- âœ… Complete API endpoint documentation
- âœ… Interactive testing interface
- âœ… Request/response examples
- âœ… Authentication testing with JWT tokens
- âœ… Schema validation and examples

## Features

### âœ… Authentication Endpoints
- **POST `/api/auth/register`** - Create account with registration key
- **POST `/api/auth/login`** - Sign in with email/password
- **POST `/api/auth/forgot-password`** - Request password reset
- **POST `/api/auth/reset-password`** - Reset password with token
- **POST `/api/auth/verify-email`** - Verify email address
- **POST `/api/auth/validate-key`** - Validate registration key

### âœ… User Management
- **GET `/api/users/profile`** - Get user profile
- **PUT `/api/users/profile`** - Update user profile
- **PUT `/api/users/change-password`** - Change password

### âœ… Security Features
- Role-based access control (6 user roles)
- Registration key system (admin-generated unique keys)
- JWT authentication with configurable expiration
- bcrypt password hashing (12 salt rounds)
- Email verification for new accounts
- Password reset with secure tokens
- Rate limiting and CORS protection

### âœ… Database Features
- PostgreSQL with Drizzle ORM
- Complete schema for users, registration keys, schools, books, chapters
- Database migrations and seeding
- Neon.tech cloud database support

### âœ… Testing
- Comprehensive test suite with Jest
- Unit tests for services, controllers, and utilities
- Mocked database operations
- 40+ test cases covering all auth flows

## User Roles

1. **Admin** - Full system access, can create registration keys
2. **Moderator** - Content moderation capabilities
3. **Author** - Content creation and publishing
4. **School** - Educational institution management
5. **Teacher** - Classroom and student management
6. **Student** - Content consumption and learning

## API Response Format

### Success Response
```json
{
  "success": true,
  "message": "Operation successful",
  "data": {
    // Response data
  }
}
```

### Error Response
```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "Error description",
    "details": {
      // Additional error details
    }
  }
}
```

## Registration Key System

Registration requires a valid key generated by administrators:

1. **Admin creates keys** using admin endpoints
2. **Users register** with their assigned key
3. **Key assigns role** automatically during registration
4. **Keys track usage** and can have expiration dates

## Development

### Available Scripts
- `npm run dev` - Start development server with hot reload
- `npm run build` - Build for production
- `npm start` - Start production server
- `npm test` - Run test suite
- `npm run test:coverage` - Run tests with coverage report
- `npm run lint` - Lint code
- `npm run format` - Format code

### Project Structure
```
src/
â”œâ”€â”€ config/          # Database and configuration
â”œâ”€â”€ controllers/     # Route controllers
â”œâ”€â”€ middleware/      # Express middleware
â”œâ”€â”€ models/          # Drizzle schemas
â”œâ”€â”€ routes/          # API routes
â”œâ”€â”€ services/        # Business logic
â”œâ”€â”€ types/           # TypeScript types
â”œâ”€â”€ utils/           # Utility functions
â””â”€â”€ scripts/         # Database scripts
```

### Test Coverage
- **Services**: AuthService, RegistrationKeyService
- **Controllers**: AuthController
- **Utils**: Crypto utilities
- **Integration**: Full API endpoint testing

## Production Deployment

### Prerequisites
- Node.js 18+
- PostgreSQL database
- SMTP email service
- Environment variables configured

### Deployment Steps
1. Set up PostgreSQL database (recommend Neon.tech)
2. Configure environment variables
3. Run database migrations
4. Create super admin user
5. Deploy to your hosting platform

### Recommended Hosting
- **Database**: Neon.tech PostgreSQL
- **API**: Vercel, Railway, or Heroku
- **Email**: Gmail SMTP, SendGrid, or Mailgun

## Security Considerations

- All passwords are hashed with bcrypt
- JWT tokens include expiration
- Rate limiting prevents abuse
- Email verification required
- Registration keys prevent unauthorized signups
- CORS and security headers configured
- Input validation on all endpoints

## Health Check

The API includes a health check endpoint:

**GET `/health`**
```json
{
  "service": "kokzhiek-editor-backend",
  "version": "1.0.0",
  "status": "healthy",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

---

Ready to use! ðŸš€

For questions or support, check the documentation or create an issue.